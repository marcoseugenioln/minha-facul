-- SQL de criação do banco de dados para a ferramenta minhaFacul
-- Alexandre CASTILHO 21/04/2023
-- FACULDADE definition
CREATE TABLE IF NOT EXISTS FACULDADE (
	FACULDADE_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	FACULADE TEXT(300),
	LOCAL_TXT TEXT(300),
	LOCAL_LAT REAL,
	LOCAL_LON REAL,
	CONSTRAINT FACULDADE_UN UNIQUE (FACULADE)
);

-- CURSO definition
CREATE TABLE IF NOT EXISTS CURSO (
	CURSO_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	CURSO TEXT(300),
	CONSTRAINT CURSO_UN UNIQUE (CURSO)
);


-- USUARIO definition
CREATE TABLE IF NOT EXISTS USUARIO (
	USUARIO_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	EMAIL TEXT(300),
	SENHA_SHA256 TEXT(64),
	RECUPERA_SENHA INTEGER DEFAULT (0),
	ADMINISTRADOR INTEGER DEFAULT (0),
	CURSO_ID INTEGER,
	LOCAL_TXT TEXT(300),
	LOCAL_LAT REAL,
	LOCAL_LON REAL,
	CONSTRAINT USUARIO_UN UNIQUE (EMAIL),
	CONSTRAINT USUARIO_FK FOREIGN KEY (CURSO_ID) REFERENCES CURSO(CURSO_ID)
);


-- HISTORICO definition
CREATE TABLE IF NOT EXISTS HISTORICO (
	HISTORICO_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	FACULDADE_ID INTEGER,
	CURSO_ID INTEGER,
	ANO INTEGER,
	VAGAS INTEGER,
	CANDIDATOS INTEGER,
	CONSTRAINT HISTORICO_UN UNIQUE (FACULDADE_ID,CURSO_ID,ANO),
	CONSTRAINT HISTORICO_FK FOREIGN KEY (FACULDADE_ID) REFERENCES FACULDADE(FACULDADE_ID),
	CONSTRAINT HISTORICO_FK_1 FOREIGN KEY (CURSO_ID) REFERENCES CURSO(CURSO_ID)
);


-- Comparativo entre faculdades para o ano atual e ultimos dois
CREATE VIEW  IF NOT EXISTS COMPARATIVO AS
SELECT A.FACULDADE_ID, A.CURSO_ID, D.FACULADE, E.CURSO, D.LOCAL_LAT, D.LOCAL_LON,
	CAST(CAST(A.CANDIDATOS AS REAL) / CAST(A.VAGAS AS REAL) AS REAL(10,2)) AS CPV,
	CAST(CAST(B.CANDIDATOS AS REAL) / CAST(B.VAGAS AS REAL) AS REAL(10,2)) AS CPV_1,
	CAST(CAST(C.CANDIDATOS AS REAL) / CAST(C.VAGAS AS REAL) AS REAL(10,2)) AS CPV_2
FROM
    (SELECT * FROM HISTORICO WHERE ANO = strftime('%Y', 'now')) AS A
LEFT JOIN
    (SELECT * FROM HISTORICO WHERE ANO = strftime('%Y', 'now')-1) AS B
USING (FACULDADE_ID, CURSO_ID)
LEFT JOIN
    (SELECT * FROM HISTORICO WHERE ANO = strftime('%Y', 'now')-2) AS C
USING (FACULDADE_ID, CURSO_ID)
LEFT JOIN
    FACULDADE AS D
USING (FACULDADE_ID)
LEFT JOIN
    CURSO AS E
USING (CURSO_ID);

CREATE VIEW IF NOT EXISTS HISTORICO_DET AS
SELECT A.HISTORICO_ID, A.FACULDADE_ID, A.CURSO_ID, D.FACULADE, E.CURSO,	A.ANO, A.CANDIDATOS, A.VAGAS
FROM HISTORICO AS A
LEFT JOIN
    FACULDADE AS D
USING (FACULDADE_ID)
LEFT JOIN
    CURSO AS E
USING (CURSO_ID);

--########################################################
--#    DADOS DE "REAIS" PARA PRODUÇÃO USAR COM CUIDADO!  #
--########################################################

INSERT OR IGNORE INTO USUARIO	(EMAIL, SENHA_SHA256, RECUPERA_SENHA, ADMINISTRADOR, CURSO_ID, LOCAL_TXT, LOCAL_LAT, LOCAL_LON)
VALUES
    ('eu@dot.com', 'root', 0, 0, 1, '', 0, 0);

-- Cria um usuário administrador
INSERT OR IGNORE INTO USUARIO	(EMAIL, SENHA_SHA256, RECUPERA_SENHA, ADMINISTRADOR, CURSO_ID)
VALUES
    ('root@root.com', 'root', 0, 1, 0),
    ('marcos@root.com', 'root', 0, 1, 0),
    ('castilho@root.com', 'root', 0, 1, 0),
    ('machado@root.com', 'root', 0, 1, 0),
    ('luciano@root.com', 'root', 0, 1, 0);

INSERT OR IGNORE INTO CURSO (CURSO) VALUES
	('Eixo Computação'),
	('Eixo Licenciaturas'),
	('Eixo de Negócios e Produção');

INSERT OR IGNORE INTO FACULDADE
(FACULADE, LOCAL_TXT, LOCAL_LAT, LOCAL_LON)
VALUES
('Univesp Polo Caçapava', 'Rua André Santos de Oliveira Lima, 15, Vila André Martins, CEP 12280-096.', -23.0872598509486, -45.7085618314527),
('Univesp Polo Jacareí', 'Rua Faria Lima, 155, Jardim Santa Maria, CEP 12328-070.', -23.2947457820243, -45.9665332899051),
('Univesp Polo SJC - Santana', 'Avenida Olivo Gomes, 250 – Santana, São José dos Campos. CEP: 12211-115', -23.1699509054071, -45.8904472873284),
('Univesp Polo SJC - Pq Tecnológico', 'Avenida Doutor Altino Bondesan, 500 - Distrito de Eugênio de Melo- CEP: 12247-016', -23.1898310522307, -45.7880568312612),
('Univesp Polo SJC - São Francisco Xavier', 'Estrada Municipal Vereador Pedro David, n° 19251- CEP: 12249-000', -22.9101380985549, -45.9520218303135),
('Univesp Polo Taubaté', 'SP-062, n° 220 - Jardim Jaraguá 12062-400', -23.0091777534579, -45.5484733163522),
('Univesp Polo Tremembé', 'R. Antônio Lourenço Xavier, 102 - Jardim Bom Jesus - CEP 12120-970', -22.9645003300476, -45.550050201434);

INSERT OR IGNORE INTO HISTORICO (FACULDADE_ID, CURSO_ID, ANO, VAGAS, CANDIDATOS)
VALUES
-- 2023
(1, 1, 2023, 10, 7),
(1, 2, 2023, 10, 30),
(1, 3, 2023, 10, 13),
(2, 1, 2023, 30, 91),
(2, 2, 2023, 30, 77),
(2, 3, 2023, 30, 83),
(3, 1, 2023, 15, 42),
(3, 2, 2023, 15, 26),
(3, 3, 2023, 15, 32),
(4, 1, 2023, 35, 39),
(4, 2, 2023, 35, 36),
(4, 3, 2023, 35, 47),
(5, 1, 2023, 50, 55),
(5, 2, 2023, 50, 51),
(5, 3, 2023, 50, 46),
(6, 1, 2023, 50, 176),
(6, 2, 2023, 50, 171),
(6, 3, 2023, 50, 163),
(7, 1, 2023, 50, 97),
(7, 2, 2023, 50, 42),
(7, 3, 2023, 50, 55),

-- 2022
(1, 1, 2022, 10, 15),
(1, 2, 2022, 10, 24),
(1, 3, 2022, 10, 15),
(2, 1, 2022, 100, 319),
(2, 2, 2022, 100, 366),
(2, 3, 2022, 100, 372),
(3, 1, 2022, 15, 57),
(3, 2, 2022, 15, 80),
(3, 3, 2022, 15, 69),
(4, 1, 2022, 35, 73),
(4, 2, 2022, 35, 90),
(4, 3, 2022, 35, 107),
(5, 1, 2022, 80, 136),
(5, 2, 2022, 80, 101),
(5, 3, 2022, 80, 121),
(6, 1, 2022, 100, 332),
(6, 2, 2022, 100, 346),
(6, 3, 2022, 100, 335),
(7, 1, 2022, 100, 195),
(7, 2, 2022, 100, 110),
(7, 3, 2022, 100, 147),

-- 2021
(1, 1, 2021, 24, 82),
(1, 2, 2021, 24, 87),
(1, 3, 2021, 24, 87),
(2, 1, 2021, 8, 131),
(2, 2, 2021, 8, 134),
(2, 3, 2021, 8, 134),
(3, 1, 2021, 16, 68),
(3, 2, 2021, 16, 80),
(3, 3, 2021, 16, 80),
(4, 1, 2021, 24, 82),
(4, 2, 2021, 24, 87),
(4, 3, 2021, 24, 87),
(5, 1, 2021, 32, 149),
(5, 2, 2021, 32, 153),
(5, 3, 2021, 32, 153),
(6, 1, 2021, 32, 340),
(6, 2, 2021, 32, 371),
(6, 3, 2021, 32, 371),
(7, 1, 2021, 32, 168),
(7, 2, 2021, 32, 100),
(7, 3, 2021, 32, 100);
